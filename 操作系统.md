#　操作系统

tar zxvf hit

make all

make all

  ./bdg-asm

  ./dbg-c

  ./rungdb





## L1，简介

一。操作系统是什么？

是计算机硬件和软件之间的一层软件

* 方便我们使用硬件　如使用显存
* 搞笑的使用硬件，如开多个终端

二。管理那些硬件？

ｃｐｕ管理　内存管理，　终端管理，磁盘管理

文件管理，　//网络管理，电源管理，多核管理

三。要学习什么？

从应用软件出发“深入操作系统”　

* 集中使用计算机接口
* 使用显示器

从应用软件出发“进入操作系统”

* 一段文字是如何写到磁盘上的

从硬件出发“设计并实现造作系统”

* 给你一个板子，配一个操作系统

８个试验

进入操作系统

能理解真是操作系统的运转

四，为什么要这样干？

我们要掌握计算机关键技术的工程师

老师所做的一切应该围绕学生开展

五，别的学生在干什么

别人已经掌握了ｓｖｄ　及其应用，我们还来扣高斯消元

高斯消元法：

ｓｖｄ：目前正应用到很多领域

斯坦福怎么学操作系统，ｃｍｕ呢？

试验１　扩展线程　实现线程调度

试验２　实现操作系统调用　将整个接口剥掉，添加

试验３　实现虚拟管理　扩展实现内存管理

试验４　扩展文件系统　扩展实现一个文件管理



##　L2，揭开钢琴的盖子

从打开电源开始？

着神秘的黑色背后发生着什么

不要总等着别人告诉你答案，尽量自己取寻找答案

　从知识和常识除法进行思索

　打开电软->计算机要开始工作了

　计算机怎么工作？



从白纸到图灵机？

说道低就是图灵机

３＋２　人看到，大脑计算，写出来

控制器读纸带　查表　控制器写出



从图灵机到通用通用图灵机

设置控制器动作，控制器状态　数据对象

　　　修改控制器

控制器增加逻辑



从图灵机到计算机

伟大的想法工程实现

伟大的发明？　冯诺依曼　存储程序思想



ＰＣ

存储器　　　　　运算器　

　　　　　　　　控制器

计算机是怎么工作的？取址执行



打开电源，计算机执行的第一句指令是什么？

计算机刚打开电源时：ｉｐ＝？

由硬件设计着决定

对于ｘ８６结构

1. x86刚开机时ｃｐｕ处于实模式
2. 开机时，ｃｓ＝ｏｘｆｆｆｆ，ｉｐ＝ｏｘ００００
3. 寻址ｏｘｆｆｆｆ０（ＲＯＭ　ＢＩＯＳ映射区）
4. 检查ＲＡＭ，键盘，显示器，软硬件磁盘
5. 将磁盘０磁道读入ｏｘ７ｃ００处（引导扇区）
6. 设置ｃｓ＝ｏｘ０７ｃｏ　ｉｐ＝ｏｘ００００

引导扇区代码：ｂｏｏｔｓｅｃｔ.s是汇编代码，严格控制内存落脚点

操作系统启动的故事

##　L3，操作系统启动

setup模块

将完成ｏｓ启动前的设置

进入保护模式

保护模式下的地址翻译和中断处理

跳转到ｓｙｓｔｅｍ模块执行

学会编写ｍａｋｅｆｉｌｅ

ｈｅａｄ.s一段在保护模式下运行的代码

通过汇编去调用ｃ语言

设置了页表之后

ｍｅｎ_init内存初始化

..... 各种数据结构初始化



１．读入内存　读入操作系统

２，初始化　　初始化一些数据



##　L4，操作系统接口

###　接口：

链接两个东西，信号转换，屏蔽细节

什么是操系统接口？

链接上层用户和操作系统软件

学会问问题

命令行是怎么回事？

ｓｙｓｔｅｍ　ｃａｌｌ

## L5，系统调用的实现

实现一个ｗｈｏａｍｉ系统调用

应用不能随意访问内存，因为内存中有重要信息，如果你可以访问不是不安全吗



用户程序调用ｗｈｏａｍｉ，一个字符串“ｌｉｚｈｉｊｕｎ”放在操作系统中

，取出来打印

不能随意调用数据，不能随意的ｊｍｐ

可以看到ｒｏｏｔ密码

可以通过显存看到别人ｗｏｒｄ里的东西



内核态　用户态



主动进入中断的方法，通过中断

int 0x80　进入

用户调用ｐｒｉｎｔｆ

ｐｒｉｎｔｆ展开成ｉｎｔｒｏｘ８０　

ｓｙｓｔｅｍ中断处理

ｓｙｓ——ｃａｌｌ——ｔａｂｌｅ查表

ｎｒ_ｗｒｉｔｅ　

ｓｙｓ——ｗｒｉｔｅ调用



##　Ｌ６，操作系统的历史，读史使人明智

###　读历使人明智

从ｉｂｓｙｓ到ｏｓ３６０

　　需要让计算机干多种事情

　　多道程序

　　作业直接额切换和调度成为核心，

　　典型代表：ｉｂｍ　ｏｓ/３６０

　　　　　　　５０００一年

从ｏｓ/360到ｍｕｌｔｉｃｓ

　　分时启动作业，使人数之间的快速切换

　　分时系统

　　代表：

　　核心是任务切换

ｍｕｌｔｉｃｓ　到unix

ｕｎｉｘ是一个简化的ｍｕｌｔｉｃｓ。核心概念杀不多，但更灵活和成功

ｕｎｉｘ到ｌｉｎｕｘ（１９９０－２０００）



掌握操作系统多进程图谱并实现它

核心思想，技术

软件工程思想



另一条历史线：

ｐｓ与ｄｏｓ

qdos与ｍｓ－ｄｏｓ

ms-dos到Ｗｉｎｄｏｗｓ

  通过文件使用计算机



ｍａｃ　ｏｓ与　ｉｏｓ时间线线



（１）掌握，实现操作系统的多进程和那个图谱；

（２）掌握，实现操作系统的文件操作视图



## L７，我们的任务

进程（多进程文件）

内存

文件（文件系统，设备文件）

##　L8，cpu管理的直观想法

管理ｃｐｕ，先要使用ｃｐｕ

　　ｃｐｕ的工作原理

　　ｃｐｕ上电以后发生了什么

看到这样的的问题，提出问题？

ｉ/o非常的慢

一条i/o指令大约是１０^6次方的计算指令

　怎么解决？

　　读写磁盘的时候来回切换，交替执行

一个ｃｐｕ上交替之心多个程序：并发

怎么做到？

　　ｐｃ进行切换　ｍｏｖ　ｐｃ　２０４

　有一个存放信息的结构ｐｃｂ

运行的程序和静态程序不一样了

引入“进程”概念：完好的刻画一个东西

运行的程序和静态程序不一样，

　　需要描述这些不一样

　　程序＋所有这些不一样－》一个概念

　　素有的不一样都表现ｐｃｂ中

进程是进行（执行）中的程序

　　进程有开始，有结束，程序没有

　　进程会走走停停，走停对程序无意义

　　进程需要记录ａｘ，ｂｘ，，程序不用

##　L9，多进程图像

多个进程使用ｃｐｕ的图像

如何充分利用ｃｐｕ呢

启动了程序就是进程，所以是多个进程推进

ｍａｉｎ中的ｆｏｒｋ创建了第一个进程

ｉｎｉｔ执行了ｓｈｅｌｌ

ｓｈｅｌｌ再启动其他进程



多进程如何组织

有一个进程在执行？

有一些进程等待执行？　ｐｃｂ队列　就绪队列

有一些进程在等待某事件？



新建态－就绪态－运行态－终止态

　　　　　　阻塞态

多进程组织：ｐｃｂ＋状态＋队列

多进程图像：多进程如何交替

启动磁盘读写：

交替：队列操作＋调度＋切换

进程的调度，是一个很深的话题

FIFO？　显然是公平的策略

ｐｒｉｏｒｉｔｙ 优先级应该怎么设定？　可能会使某些进程饥饿



多进程图像：多进程如何影响？

多个进程同事存在与内存会出现下面的问题？

　　进程带动内存的使用地址分离？映射表的实现

多进程图像：多进程如何合作？

想一想打印工作过程

　　应用程序提交打印任务

　　打印任务被放进打印队列

　　答应进程从队列中取出任务

　　答应进程控制打印机打印

　　从纸片到实际：生产者－消费者

　　进程同步（合理的推进顺序）



##　L10，用户级线程

将资源和指令执行分开，内存不用切

线程：保留了并发的特点

避免了进程切换代价



指令的切换，映射表的切换



多个执行序列＋一个地址空间是否使用？

一个网页浏览器，　这些线程要贡献资源吗？



两个执行序列与一个栈？

会出错，解决两个栈

栈ｔｃｂ　ｒｅｔ栈的数据

ｅｓｐ指针

### 问题？ｙｉｅｌd多线程问题用户态

还有一个问题？内核看不见浏览器的多线程，如果在调用内核时，内核中阻塞

ｃｐｕ就跳走了，，还是间断显示

##　L11，核心级线程

多处理器　　　　　　　　　多核

每个都有一个映射　　　　　公用一个映射



和用户级相比，核心级线程有啥不同

有两套栈，

内核栈，

通过中断进入内核



内核级别线程五段论

中断入口

找到ｔｃｂ

找到内核栈

完成内核栈切换

中断返回



## L12，核心级线程实现

###　哎，

中断

创建子进程

如何执行代码	

##　L13，操作系统的那棵“树”

the mind is not a vessel that needs filling,but wood that needs igniting

ｂｕｔ 你要有材料啊！！！

思考才是王道，但是要省时才行



１，ｃｐｕ要运行

　　问题？　ｃｐｕ没有好好运转

　　形成多个程序的切换

　　形成切换，保存现场，用栈，用两个栈，

　　进行限制，用内核栈，切换内核栈

　　试验交替的打印ａｂ

###　　连续性（不断的往外扩展）

非连续性思维，四周性扩散，发散思维也是一种方式

　　运用时钟中断

　　打印ａ，时钟中断，切换，打印ｂ，时钟中断，切换

##　L14，ｃｐｕ调度策略

算法怎么才能更好？

　面对客户：银行调度算法应该是：用户满意

　面对进程：ｃｐｕ调度的目标应该是　进程满意

那怎么才能让进程满意呢？　时间

　尽快结束任务：周转时间短

　用户操作尽快响应：响应时间短

　系统内耗时间少：吞吐量

总原则：系统专注与任务执行，又能合理调配，，

如何做到合理？　需要折中，和综合

　　吞吐量和响应时间之间有矛盾

　前台任务和后台任务的关注点不同

　　前台任务关注响应时间，后台分吴挂住周转时间

ｉｏ约束型任务和ｃｐｕ约束型任务有各自的特点

　　平均周转时间？

先来先出，公平

短作业优先的放方法，总周转的时间最小　

　　响应时间该怎么办

轮转调度，响应时间太长



优先级调度

前台任务，高一点

后台任务，低一点

　　故事：有一个在１９６７年提交的程序在１９７３年还没有运行

后台任务优先级升高

前台任务都用时间片

调度算法应该认识前台后台任务



##　L15，一个实际的ｓｃｈｅｄｕｌｅ函数

counter代表的优先级可以动态调整

阻塞的进程再就绪以后优先级高于非阻塞进程，为什么？

进程为什么会阻塞？ｉ/o，正是前台进程的特征

保证响应时间的界　时间片最大是２ｐ

周转时间最大是２ｎｐ

ｃｐｕ调度：一个简单的算法折中了大多数任务



##　L16，进程同步与信号量

进程合作：多进程共同完成一个任务

只发送信号还不能解决问题，

　生产者执行一段时间会执行ｓｌｅｅｐ

　消费者执行一段时间会执行ｗａｋｅｕｐ

不仅要发送一个信号我们还需要一个量来判断　是否发信号，等待了几个进程

不只是等待信号，发信号？对应睡眠和唤醒！

还应该记录一些信息

　　（１）缓冲队列，ｐ１执行，ｐ１ｓｌｅｅｐ　记录下一个进程等待

　　（２）ｐ２执行，记录下２个进程等待

　　（３）ｃ执行１次循环，发现２个进程等待，ｗａｋｅｕｐ个





　